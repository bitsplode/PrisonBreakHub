local TweenService = game:GetService("TweenService")
local trainRobbery = require(game.ReplicatedStorage.Module.TrainRobbery)
local player = game.Players.LocalPlayer
local vehicles = {}
local function getAllVehicles()
	for i, v in pairs(workspace:GetChildren()) do
		if v:FindFirstChild("PacketID") and v.Name == "Camaro" then
			table.insert(vehicles, v.DriveSeat)
		end
	end
end

local function fetchKeybind(action, packet)
	game.ReplicatedStorage.Remotes.Server.VerifyAction:FireServer(action, packet)
end

local function nearestVehicle()
	getAllVehicles()
	local closest, seat = math.huge, nil
	for i, v in pairs(vehicles) do
		local newMag = (v.Position - player.Character.HumanoidRootPart.Position).Magnitude
		if newMag < closest then
			closest = newMag
			seat = v
		end
	end
	return {seat}
end

local function tweento(part, pos, speed, cframe)
	local velocity = Instance.new("BodyVelocity", part)
	velocity.Name = "nil"
	velocity.Velocity = Vector3.new(0,0,0)
	
	if part:FindFirstChild("Humanoid") then
		game.Players.LocalPlayer.Character.Humanoid:ChangeState(11)
		game.Players.LocalPlayer.Character.Humanoid.Jump = true
	end
	
	local calculation = (part.Position - pos).Magnitude / (speed)
	local Tween = TweenService:Create(part, TweenInfo.new(calculation, Enum.EasingStyle.Linear), {CFrame = cframe})
	Tween:Play()
	wait(calculation + .5)
	velocity:Destroy()
end

local function getObjectNear(location)
	local closest, object = math.huge, nil
	for i, v in pairs(workspace:GetChildren()) do
		if v:IsA("BasePart") then
			local mag = (v.Position - location).Magnitude
			if mag < closest then
				closest = mag
				object = v
			end
		end
	end
	return object
end

local function findMainTrainCar()
	if workspace:FindFirstChild("Trains") then
		for i, v in pairs(workspace:FindFirstChild("Trains"):GetChildren()) do
			if v.Name == "MainCar" then
				return v
			end
		end
	else
		return
	end
end

local function encryptTrain()
	if workspace:FindFirstChild("Trains") then
		for i, v in pairs(workspace:FindFirstChild("Trains"):GetChildren()) do
			if v.Name == "MainCar" then
				v.Name = "NotRelevant"
			end
		end
	else
		return
	end
end

local function checkForOpenStores()
	local serverRoomLever = getObjectNear(Vector3.new(-1994.646, 6.431, -1798.945))
	local donutStoreRegister = getObjectNear(Vector3.new(-1969.333, 6.029, -1452.909))
	if serverRoomLever.Action.Value == "OpenVault" or workspace.Servers.Union:FindFirstChild("Value") == "ServerHack" then
		local function checkServers()
			for i, v in pairs(workspace.Servers:GetChildren()) do
				if v.Action.Value == "nil" then
					return false
				else
					return true
				end
			end
		end
		if checkServers() then
			return "ServerRoomServers"
		else
			return "ServerRoomLever"
		end
	elseif workspace:FindFirstChild("Trains") and #workspace:FindFirstChild("Trains"):GetChildren() > 0 then
		if workspace:FindFirstChild("Trains"):FindFirstChild("MainCar") then
			return "TrainMainCar"
		else
			print("Scam Train, skipping.")
		end
	elseif donutStoreRegister.Action.Value == "RobDonutStore" then
		print("xd")
		return "DonutStore"
	else
		return "AllStoresClosed"
	end
end

local function enterVehicle(findVehicle)
	fetchKeybind("EnterVehicle", findVehicle)
end

local function vehicle()
	repeat
		local findVehicle = nearestVehicle()
		tweento(player.Character.HumanoidRootPart, findVehicle[1].Position, 25, findVehicle[1].CFrame)
		enterVehicle(findVehicle)
		wait()
	until player.Character.Humanoid.SeatPart ~= nil
end

for i, v in pairs(workspace:GetChildren()) do
	if v:FindFirstChild("Script") then
		v.Position = Vector3.new(0,0,0)
	end
end

while true do
	if player.Team == game.Teams.Prisoner then
		-- Escaping!
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-2194, 61.45, -1448))
		end
	end
	local value = checkForOpenStores()
	if value == "ServerRoomServers" then
		local server = getObjectNear(Vector3.new(-2001.215, 6.977, -1699.972))
		local findVehicle = nearestVehicle()
		vehicle()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-2030, 18.5, -1672))
		end
		player.Character.Humanoid.Jump = true
		tweento(player.Character.HumanoidRootPart, Vector3.new(-2001.215, 6.977, -1699.972), 25, CFrame.new(-2001.215, 6.977, -1699.972))
		fetchKeybind("ServerHack", {server})
		wait()
		local getServerRoomRobberyGui = player.PlayerGui.Game.ServerRobbery
		if getServerRoomRobberyGui then
			for i = 6,0,-1 do
				wait(.25)
				game.ReplicatedStorage.Remotes.Server.VerifyPassword:FireServer(getServerRoomRobberyGui.Password.Text)
			end
		end
		wait(1)
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-2242, 562.146, -1702))
		end
	elseif value == "ServerRoomLever" then
		local lever = getObjectNear(Vector3.new(-1994.646, 6.431, -1798.945))
		local findVehicle = nearestVehicle()
		vehicle()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-1988.97, 6.807, -1869.442))
		end
		wait(1)
		player.Character.Humanoid.Jump = true
		tweento(player.Character.HumanoidRootPart, Vector3.new(-1994.646, 6.431, -1798.945), 25, CFrame.new(-1994.646, 6.431, -1798.945))
		fetchKeybind("OpenVault", {lever})
		-- ServerRoom
		local server = getObjectNear(Vector3.new(-2001.215, 8.977, -1720.282))
		tweento(player.Character.HumanoidRootPart, Vector3.new(-2001.215, 8.977, -1720.282), 25, CFrame.new(-2001.215, 8.977, -1720.2822))
		wait()
		fetchKeybind("ServerHack", {server})
		wait()
		local getServerRoomRobberyGui = player.PlayerGui.Game.ServerRobbery
		if getServerRoomRobberyGui then
			for i = 5,0,-1 do
				wait(1)
				game.ReplicatedStorage.Remotes.Server.VerifyPassword:FireServer(getServerRoomRobberyGui.Password.Text)
			end
		end
		wait(1)
		-- Crim Base
		
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-1579.709, 16.922, 425.595))
		end
		
		-- Plate
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-2242, 562.146, -1702))
		end
	elseif value == "TrainMainCar" then
		wait(15)
		local mainCar = findMainTrainCar()
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(mainCar.Model.RobPart.Position))
		end
		wait()
		player.Character.Humanoid.Jump = true
		wait()
		player.Character.HumanoidRootPart.CFrame = CFrame.new(mainCar.Model.RobPart.Position)
		wait(1)
		for i = 21,0,-1 do
			wait()
			trainRobbery:fetch("RobTrain", true)
		end
		wait(.5)
		vehicle()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-1579.709, 16.922, 425.595))
		end
		encryptTrain()
	elseif value == "DonutStore" then
		local findVehicle = nearestVehicle()
		vehicle()
		wait()
		local primPart = findVehicle[1].Parent
		if primPart then
			primPart:SetPrimaryPartCFrame(CFrame.new(-1970, 12.807, -1398))
		end
		player.Character.Humanoid.Jump = true
		tweento(player.Character.HumanoidRootPart, Vector3.new(-1969.333, 6.029, -1452.909), 25, CFrame.new(-1969.333, 6.029, -1452.909))
		local donutStoreRegister = getObjectNear(Vector3.new(-1969.333, 6.029, -1452.909))
		fetchKeybind("RobDonutStore", {donutStoreRegister})
	else
		if workspace:FindFirstChild("SkyPlatformAutoRob") then
			local findVehicle = nearestVehicle()
			vehicle()
			wait()
			local primPart = findVehicle[1].Parent
			if primPart then
				primPart:SetPrimaryPartCFrame(CFrame.new(-2242, 562.146, -1702))
			end
		else
			local plate = Instance.new("Part", workspace)
			plate.Size = Vector3.new(66.33, 2.013, 77.398)
			plate.Position = Vector3.new(-2241.335, 546.64, -1701.126)
			plate.Anchored = true
			wait()
			local magnitude = (Vector3.new(-2241.335, 546.64, -1701.126) - player.Character.HumanoidRootPart.Position).Magnitude
			if magnitude > 50 then
				local findVehicle = nearestVehicle()
				vehicle()
				wait()
				local primPart = findVehicle[1].Parent
				if primPart then
					primPart:SetPrimaryPartCFrame(CFrame.new(-2242, 562.146, -1702))
				end
			else
				local findVehicle = nearestVehicle()
				vehicle()
			end
		end
	end
	wait(1)
end
